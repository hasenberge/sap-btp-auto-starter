name: Keep SAP BTP App Alive

on:
  schedule:
     - cron: '30 1 * * *'  # 每天北京时间9点10分运行（UTC时间1点10分）
  workflow_dispatch:     # 允许手动触发
jobs:
  keep-alive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Cloud Foundry CLI (fixed download link)
        run: |
          # 初始化日志文件
          touch /tmp/btp_operations.log
          chmod 666 /tmp/btp_operations.log
          echo "=== Starting CF CLI installation ===" | tee -a /tmp/btp_operations.log

          # 使用最新的CF CLI下载链接（来自官方文档）
          echo "=== Downloading CF CLI ===" | tee -a /tmp/btp_operations.log
          # 新链接：直接指向最新稳定版linux64二进制文件
          wget -O cf.tgz "https://cli.run.pivotal.io/stable?release=linux64-binary&source=github" 2>&1 | tee -a /tmp/btp_operations.log
          
          # 检查下载是否成功
          if [ ! -f "cf.tgz" ] || [ $(stat -c%s "cf.tgz") -lt 1000000 ]; then
            echo "=== Failed: CF CLI下载文件不存在或不完整 ===" | tee -a /tmp/btp_operations.log
            exit 2
          fi

          # 解压并安装
          echo "=== Extracting CF CLI ===" | tee -a /tmp/btp_operations.log
          sudo tar -zxvf cf.tgz -C /usr/local/bin 2>&1 | tee -a /tmp/btp_operations.log
          
          if ! command -v cf &> /dev/null; then
            echo "=== Failed: CF CLI解压失败 ===" | tee -a /tmp/btp_operations.log
            exit 3
          fi

          # 验证版本
          echo "=== CF CLI version ===" | tee -a /tmp/btp_operations.log
          cf --version 2>&1 | tee -a /tmp/btp_operations.log
          echo "=== CF CLI installed successfully ===" | tee -a /tmp/btp_operations.log

      - name: Login to SAP BTP and access app
        id: btp-operations
        continue-on-error: true
        run: |
          echo "=== Starting SAP BTP operations ===" | tee -a /tmp/btp_operations.log
          
          if [ -z "${{ secrets.CF_API_URL }}" ] || [ -z "${{ secrets.CF_USERNAME }}" ] || [ -z "${{ secrets.CF_PASSWORD }}" ]; then
            echo "=== Failed: 缺少必要的secrets ===" | tee -a /tmp/btp_operations.log
            exit 4
          fi
          
          # 登录操作
          echo "=== Logging in to SAP BTP ===" | tee -a /tmp/btp_operations.log
          cf login \
            -a "${{ secrets.CF_API_URL }}" \
            -u "${{ secrets.CF_USERNAME }}" \
            -p "${{ secrets.CF_PASSWORD }}" \
            -o "${{ secrets.CF_ORG }}" \
            -s "${{ secrets.CF_SPACE }}" \
            --skip-ssl-validation 2>&1 | tee -a /tmp/btp_operations.log
          
          if [ $? -ne 0 ]; then
            echo "=== Failed: SAP BTP登录失败 ===" | tee -a /tmp/btp_operations.log
            exit 8
          fi
          
          # 访问应用
          echo "=== Retrieving app list ===" | tee -a /tmp/btp_operations.log
          cf apps 2>&1 | tee -a /tmp/btp_operations.log
          
          if [ -n "${{ secrets.APP_NAME }}" ]; then
            echo "=== Accessing app ${{ secrets.APP_NAME }} ===" | tee -a /tmp/btp_operations.log
            APP_URL=$(cf app ${{ secrets.APP_NAME }} | grep -o 'https://[^ ]*')
            if [ -n "$APP_URL" ]; then
              curl -s -L -w "HTTP Status: %{http_code}\n" "$APP_URL" -o /dev/null 2>&1 | tee -a /tmp/btp_operations.log
              echo "Successfully accessed app URL: $APP_URL" | tee -a /tmp/btp_operations.log
            else
              echo "=== Warning: 无法获取应用URL ===" | tee -a /tmp/btp_operations.log
            fi
          fi

      - name: Save operation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: btp-operation-logs
          path: /tmp/btp_operations.log
          if-no-files-found: warn
          retention-days: 7
