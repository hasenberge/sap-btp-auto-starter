name: Daily Startup for SAP BTP App

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  start-app:
    runs-on: ubuntu-latest
    steps:
      - name: Install CF CLI
        run: |
          wget -q -O cf.tgz "https://packages.cloudfoundry.org/stable?release=linux64-binary&version=8&source=github"
          sudo tar -zxvf cf.tgz -C /usr/local/bin
          cf --version

      - name: Debug - Show masked secrets (for verification)
        run: |
          echo "API Endpoint: ${{ secrets.CF_API_URL }}"
          echo "Username: ${{ secrets.CF_USERNAME }}"
          echo "Organization: ${{ secrets.CF_ORG }}"
          echo "Space: ${{ secrets.CF_SPACE }}"
          echo "App Name: ${{ secrets.CF_APP_NAME }}"
          # The actual values are masked by GitHub, but this confirms the step runs.

      - name: Attempt Login with Trace (This will reveal the true error)
        run: |
          # The CF_TRACE=true environment variable will print detailed logs to stderr
          CF_TRACE=true cf login -a "${{ secrets.CF_API_URL }}" \
                   -u "${{ secrets.CF_USERNAME }}" \
                   -p "${{ secrets.CF_PASSWORD }}" \
                   -o "${{ secrets.CF_ORG }}" \
                   -s "${{ secrets.CF_SPACE }}" \
                   --skip-ssl-validation # Skip SSL verification if needed, but try without first.
        continue-on-error: true # This allows the next step to run even if login fails

      - name: Final Login Attempt
        run: |
          # This is the clean attempt after we've seen the trace logs
          cf login -a "${{ secrets.CF_API_URL }}" \
                   -u "${{ secrets.CF_USERNAME }}" \
                   -p "${{ secrets.CF_PASSWORD }}" \
                   -o "${{ secrets.CF_ORG }}" \
                   -s "${{ secrets.CF_SPACE }}"

      - name: Start Application
        run: cf start "${{ secrets.CF_APP_NAME }}"
